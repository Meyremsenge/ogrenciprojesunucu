var $=Object.defineProperty;var F=(a,t,n)=>t in a?$(a,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):a[t]=n;var q=(a,t,n)=>F(a,typeof t!="symbol"?t+"":t,n);import{a as U,b as Q,j as e}from"./query-CZD0ZRD-.js";import{b as H,c as G,r as d}from"./vendor-izpyVFLd.js";import{u as V,B as C,c as N}from"./index-CJixA8aD.js";import{B as X}from"./Badge-CA9YTxat.js";import{a as j}from"./api-Tqb-OO70.js";import{a as D,D as J,S as W,J as Y,B as Z,K as ee,H as te,A as se,m as ae,p as B,aF as ne,aQ as re,U as ie,aO as oe}from"./ui-CAO-iScS.js";import"./charts-Db6Lds24.js";const A={maxRequestsPerMinute:10,minRequestInterval:3e3},O={maxMessageLength:2e3};class ce{constructor(){q(this,"requests",[]);q(this,"lastRequestTime",0)}canMakeRequest(){const t=Date.now(),n=t-this.lastRequestTime;if(n<A.minRequestInterval)return{allowed:!1,waitTime:A.minRequestInterval-n};const r=t-6e4;if(this.requests=this.requests.filter(i=>i>r),this.requests.length>=A.maxRequestsPerMinute){const i=this.requests[0];return{allowed:!1,waitTime:6e4-(t-i)}}return{allowed:!0}}recordRequest(){this.requests.push(Date.now()),this.lastRequestTime=Date.now()}}const l=new ce;function M(a){let t=a.slice(0,O.maxMessageLength);return t=t.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"").replace(/<[^>]*>/g,"").replace(/javascript:/gi,"").replace(/on\w+=/gi,""),t.trim()}function le(a){return a.slice(-10).map(n=>({...n,content:n.content.slice(0,O.maxMessageLength)}))}class o extends Error{constructor(t,n,r,i){super(t),this.code=n,this.statusCode=r,this.retryAfter=i,this.name="AIError"}}function S(a){if(a.response){const{status:t,data:n}=a.response;throw t===429?new o(n.message||"Ã‡ok fazla istek gÃ¶nderdiniz. LÃ¼tfen bekleyin.","RATE_LIMIT_EXCEEDED",t,n.retry_after):t===403?n.error_code==="EXAM_IN_PROGRESS"?new o("SÄ±nav sÃ¼resince AI asistan kullanÄ±lamaz.","EXAM_BLOCKED",t):new o(n.message||"EriÅŸim reddedildi.","ACCESS_DENIED",t):t===400?new o(n.message||"GeÃ§ersiz istek.","INVALID_REQUEST",t):new o(n.message||"Bir hata oluÅŸtu.","UNKNOWN_ERROR",t)}throw new o("BaÄŸlantÄ± hatasÄ±. LÃ¼tfen internet baÄŸlantÄ±nÄ±zÄ± kontrol edin.","NETWORK_ERROR")}const z={async getHint(a){const t=l.canMakeRequest();if(!t.allowed)throw new o(`LÃ¼tfen ${Math.ceil((t.waitTime||0)/1e3)} saniye bekleyin.`,"CLIENT_RATE_LIMIT",429,t.waitTime);const n={...a,question_text:M(a.question_text)};try{return l.recordRequest(),(await j.post("/ai/hint",n)).data.data}catch(r){S(r)}},async explainTopic(a){const t=l.canMakeRequest();if(!t.allowed)throw new o(`LÃ¼tfen ${Math.ceil((t.waitTime||0)/1e3)} saniye bekleyin.`,"CLIENT_RATE_LIMIT",429,t.waitTime);const n={...a,topic:M(a.topic)};try{return l.recordRequest(),(await j.post("/ai/explain",n)).data.data}catch(r){S(r)}},async getQuotaStatus(){try{return(await j.get("/ai/quota/status")).data.data}catch(a){S(a)}},async getQuota(){try{return(await j.get("/ai/quota")).data}catch{return{data:{used:0,limit:100}}}},async chat(a){const t=l.canMakeRequest();if(!t.allowed)throw new o(`LÃ¼tfen ${Math.ceil((t.waitTime||0)/1e3)} saniye bekleyin.`,"CLIENT_RATE_LIMIT",429,t.waitTime);const n={message:M(a.message),feature:a.feature||"general",context:a.context};try{l.recordRequest();const r=await j.post("/ai/chat",n);return r.data.data||r.data}catch(r){S(r)}},streamHint(a,t,n,r){const i=l.canMakeRequest();if(!i.allowed)return n(new o(`LÃ¼tfen ${Math.ceil((i.waitTime||0)/1e3)} saniye bekleyin.`,"CLIENT_RATE_LIMIT",429,i.waitTime)),()=>{};l.recordRequest();const w=localStorage.getItem("access_token"),y="/api/v1",v=new AbortController;return fetch(`${y}/ai/stream/hint`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${w}`},body:JSON.stringify({question_text:M(a.question_text),difficulty_level:a.difficulty_level}),signal:v.signal}).then(u=>{var E;if(!u.ok)throw new Error(`HTTP ${u.status}`);const f=(E=u.body)==null?void 0:E.getReader(),T=new TextDecoder;if(!f)throw new Error("Stream not supported");function b(){f.read().then(({done:m,value:k})=>{if(m){r();return}const I=T.decode(k).split(`
`);for(const L of I)if(L.startsWith("data: "))try{const R=JSON.parse(L.slice(6));t(R)}catch{}b()}).catch(m=>{m.name!=="AbortError"&&n(new o(m.message,"STREAM_ERROR"))})}b()}).catch(u=>{u.name!=="AbortError"&&n(new o(u.message,"STREAM_ERROR"))}),()=>{v.abort()}},checkRateLimit(){return l.canMakeRequest()},limitContext(a){return le(a)}},de=[{id:"hint",label:"Ä°pucu Al",description:"Soru Ã§Ã¶zerken yardÄ±m al",icon:Y,color:"text-yellow-600 bg-yellow-100",prompt:"Bu soru hakkÄ±nda bir ipucu verir misin?"},{id:"explain",label:"AÃ§Ä±klama",description:"Konuyu detaylÄ± Ã¶ÄŸren",icon:Z,color:"text-blue-600 bg-blue-100",prompt:"Bu konuyu bana aÃ§Ä±klar mÄ±sÄ±n?"},{id:"study-plan",label:"Ã‡alÄ±ÅŸma PlanÄ±",description:"KiÅŸisel plan oluÅŸtur",icon:ee,color:"text-green-600 bg-green-100",prompt:"Benim iÃ§in bir Ã§alÄ±ÅŸma planÄ± oluÅŸturur musun?"},{id:"question",label:"Soru Sor",description:"Merak ettiklerini sor",icon:te,color:"text-purple-600 bg-purple-100",prompt:""}],ue=`Merhaba! ðŸ‘‹ Ben senin AI Ã¶ÄŸrenme asistanÄ±nÄ±m. 

Sana ÅŸu konularda yardÄ±mcÄ± olabilirim:
â€¢ ðŸ“š KonularÄ± aÃ§Ä±klama
â€¢ ðŸ’¡ Sorularda ipucu verme
â€¢ ðŸŽ¯ Ã‡alÄ±ÅŸma planÄ± oluÅŸturma
â€¢ â“ SorularÄ±nÄ± yanÄ±tlama

Ne hakkÄ±nda konuÅŸmak istersin?`;function ke(){V();const a=H(),[t]=G(),[n,r]=d.useState([{id:"greeting",role:"assistant",content:ue,timestamp:new Date}]),[i,w]=d.useState(""),[y,v]=d.useState("general"),[u,f]=d.useState(!1),T=d.useRef(null),b=d.useRef(null),E=t.get("topic"),m=t.get("course"),{data:k}=U({queryKey:["aiQuota"],queryFn:()=>z.getQuota(),staleTime:6e4}),p=Q({mutationFn:async s=>await z.chat({message:s,feature:y,context:{topic:E||void 0,courseId:m?parseInt(m):void 0}}),onSuccess:s=>{const c={id:`assistant-${Date.now()}`,role:"assistant",content:s.response||s.message||"YanÄ±t alÄ±namadÄ±.",timestamp:new Date,feature:y};r(h=>h.filter(x=>!x.isLoading).concat(c)),f(!1)},onError:s=>{const c={id:`error-${Date.now()}`,role:"assistant",content:`ðŸ˜” Bir sorun oluÅŸtu: ${s.message||"BaÄŸlantÄ± hatasÄ±"}. LÃ¼tfen tekrar dene.`,timestamp:new Date};r(h=>h.filter(x=>!x.isLoading).concat(c)),f(!1)}});d.useEffect(()=>{var s;(s=T.current)==null||s.scrollIntoView({behavior:"smooth"})},[n]);const I=d.useCallback(async()=>{if(!i.trim()||p.isPending)return;const s={id:`user-${Date.now()}`,role:"user",content:i.trim(),timestamp:new Date},c={id:`loading-${Date.now()}`,role:"assistant",content:"",timestamp:new Date,isLoading:!0};r(h=>[...h,s,c]),w(""),f(!0),p.mutate(i.trim())},[i,p]),L=s=>{var c;v(s.id),s.prompt&&(w(s.prompt),(c=b.current)==null||c.focus())},R=(s,c)=>{r(h=>h.map(x=>x.id===s?{...x,feedback:c}:x))},P=s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),I())},g=k==null?void 0:k.data,K=(g==null?void 0:g.used)||0,_=((g==null?void 0:g.limit)||100)-K;return e.jsxs("div",{className:"flex flex-col h-[calc(100vh-8rem)] max-w-5xl mx-auto",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b bg-gradient-to-r from-primary/5 to-purple-500/5",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-full bg-gradient-to-br from-primary to-purple-600 flex items-center justify-center",children:e.jsx(D,{className:"h-5 w-5 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"font-semibold text-lg",children:"AI Ã–ÄŸrenme AsistanÄ±"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Sana Ã¶ÄŸrenmende yardÄ±mcÄ± olmak iÃ§in buradayÄ±m"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(X,{variant:_>10?"secondary":"destructive",children:[e.jsx(J,{className:"h-3 w-3 mr-1"}),_," hak kaldÄ±"]}),e.jsx(C,{variant:"ghost",size:"sm",onClick:()=>a("/settings"),children:e.jsx(W,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"flex gap-2 p-3 border-b bg-muted/30 overflow-x-auto",children:de.map(s=>e.jsxs("button",{onClick:()=>L(s),className:N("flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap",y===s.id?"bg-primary text-primary-foreground shadow-md":"bg-background hover:bg-muted border"),children:[e.jsx(s.icon,{className:"h-4 w-4"}),s.label]},s.id))}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[e.jsx(se,{children:n.map(s=>e.jsxs(ae.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:N("flex gap-3",s.role==="user"?"justify-end":"justify-start"),children:[s.role==="assistant"&&e.jsx("div",{className:"h-8 w-8 rounded-full bg-gradient-to-br from-primary to-purple-600 flex items-center justify-center flex-shrink-0",children:e.jsx(D,{className:"h-4 w-4 text-white"})}),e.jsx("div",{className:N("max-w-[80%] rounded-2xl px-4 py-3",s.role==="user"?"bg-primary text-primary-foreground rounded-tr-sm":"bg-muted rounded-tl-sm"),children:s.isLoading?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(B,{className:"h-4 w-4 animate-spin"}),e.jsx("span",{className:"text-sm",children:"DÃ¼ÅŸÃ¼nÃ¼yorum..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:s.content}),s.role==="assistant"&&!s.isLoading&&s.id!=="greeting"&&e.jsxs("div",{className:"flex items-center gap-2 mt-2 pt-2 border-t border-current/10",children:[e.jsx("span",{className:"text-xs opacity-60",children:"Bu yanÄ±t faydalÄ± mÄ±ydÄ±?"}),e.jsx("button",{onClick:()=>R(s.id,"positive"),className:N("p-1 rounded hover:bg-green-100 transition-colors",s.feedback==="positive"&&"bg-green-100 text-green-600"),children:e.jsx(ne,{className:"h-3 w-3"})}),e.jsx("button",{onClick:()=>R(s.id,"negative"),className:N("p-1 rounded hover:bg-red-100 transition-colors",s.feedback==="negative"&&"bg-red-100 text-red-600"),children:e.jsx(re,{className:"h-3 w-3"})})]})]})}),s.role==="user"&&e.jsx("div",{className:"h-8 w-8 rounded-full bg-muted flex items-center justify-center flex-shrink-0",children:e.jsx(ie,{className:"h-4 w-4"})})]},s.id))}),e.jsx("div",{ref:T})]}),e.jsxs("div",{className:"border-t bg-background p-4",children:[e.jsxs("div",{className:"flex items-end gap-2 max-w-4xl mx-auto",children:[e.jsx("div",{className:"flex-1 relative",children:e.jsx("textarea",{ref:b,value:i,onChange:s=>w(s.target.value),onKeyDown:P,placeholder:"Bir soru sor veya yardÄ±m iste...",className:"w-full resize-none rounded-xl border bg-muted/50 px-4 py-3 pr-12 text-sm focus:outline-none focus:ring-2 focus:ring-primary min-h-[48px] max-h-[120px]",rows:1,disabled:p.isPending})}),e.jsx(C,{onClick:I,disabled:!i.trim()||p.isPending,className:"h-12 w-12 rounded-xl",children:p.isPending?e.jsx(B,{className:"h-5 w-5 animate-spin"}):e.jsx(oe,{className:"h-5 w-5"})})]}),e.jsx("p",{className:"text-xs text-center text-muted-foreground mt-2",children:"AI yanÄ±tlarÄ± Ã¶ÄŸrenme desteÄŸi amaÃ§lÄ±dÄ±r. Kesin bilgi iÃ§in Ã¶ÄŸretmeninize danÄ±ÅŸÄ±n."})]})]})}export{ke as default};
